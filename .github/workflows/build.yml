# WARNING: this file is written by a script. To make changes,
# alter the config in lib/tasks/workflow.rake and 
# run `bundle exec rake workflow`.
---
name: Skylight Agent
env:
  BUNDLE_PATH: "${{ github.workspace }}/vendor/bundle"
  SKYLIGHT_EXT_STRICT: 'false'
  SKYLIGHT_REQUIRED: 'true'
  SKYLIGHT_TEST_DIR: "/tmp"
  RAILS_ENV: development
  EMBEDDED_HTTP_SERVER_TIMEOUT: '30'
  WORKER_SPAWN_TIMEOUT: '15'
  COVERAGE: 'true'
  COVERAGE_DIR: "${{ github.workspace }}/coverage"
  DISABLED_COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
  CONFIG_DIGEST: 0305d84b111ada5469ee45c68add3aaad28986058a11d3a0c39f3d0bdbd6e029
'on':
  push:
    branches:
    - master
  pull_request:
    types:
    - labeled
    - opened
    - reopened
    - synchronize
jobs:
  ruby-2-7-rails-5-2-x-mongo:
    name: ruby 2.7, rails-5.2.x, mongo
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    services:
      mongo:
        image: mongo:4.0
        ports:
        - 27017:27017
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
      TEST_MONGO_INTEGRATION: 'true'
      MONGO_HOST: localhost
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-rails-5-2-x-mongoid-6-mongoid_version-6-0:
    name: ruby 2.7, rails-5.2.x, mongoid-6, MONGOID_VERSION=~> 6.0
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    services:
      mongo:
        image: mongo:4.0
        ports:
        - 27017:27017
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
      TEST_MONGO_INTEGRATION: 'true'
      MONGO_HOST: localhost
      MONGOID_VERSION: "~> 6.0"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-rails-5-2-x-elasticsearch:
    name: ruby 2.7, rails-5.2.x, elasticsearch
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    services:
      elasticsearch:
        image: elasticsearch:6.8.6
        ports:
        - 9200:9200
        - 9300:9300
        options: -e "discovery.type=single-node"
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-5-rails-5-2-x-sidekiq_version-4-graphql_version-1-7-0:
    name: ruby 2.5, rails-5.2.x, SIDEKIQ_VERSION=~> 4 GRAPHQL_VERSION=~> 1.7.0
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
      SIDEKIQ_VERSION: "~> 4"
      GRAPHQL_VERSION: "~> 1.7.0"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.5'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.5-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.5-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-rails-5-2-x-graphql_version-1-9-0:
    name: ruby 2.7, rails-5.2.x, GRAPHQL_VERSION=~> 1.9.0
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
      GRAPHQL_VERSION: "~> 1.9.0"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-rails-5-2-x-graphql_version-1-8-0:
    name: ruby 2.7, rails-5.2.x, GRAPHQL_VERSION=~> 1.8.0
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
      GRAPHQL_VERSION: "~> 1.8.0"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-3-0-rails-6-0-x:
    name: ruby 3.0, rails-6.0.x
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-6.0.x
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.0-rails-6.0.x"
        restore-keys: "${{ runner.os }}-gems-3.0-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-3-0-rails-6-1-x:
    name: ruby 3.0, rails-6.1.x
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-6.1.x
    steps:
    - uses: technote-space/auto-cancel-redundant-job@v1
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.0-rails-6.1.x"
        restore-keys: "${{ runner.os }}-gems-3.0-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
  ruby-3-0-rails-edge-ams_version-edge:
    name: "[allowed to fail] ruby 3.0, rails-edge, AMS_VERSION=edge"
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-edge
      AMS_VERSION: edge
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.0-rails-edge"
        restore-keys: "${{ runner.os }}-gems-3.0-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-5-sinatra-1-4-x:
    name: ruby 2.5, sinatra-1.4.x
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.sinatra-1.4.x
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.5'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.5-sinatra-1.4.x"
        restore-keys: "${{ runner.os }}-gems-2.5-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-3-0-sinatra-1-4-x:
    name: ruby 3.0, sinatra-1.4.x
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.sinatra-1.4.x
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.0-sinatra-1.4.x"
        restore-keys: "${{ runner.os }}-gems-3.0-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-5-sinatra-2-0-x:
    name: ruby 2.5, sinatra-2.0.x
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.sinatra-2.0.x
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.5'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.5-sinatra-2.0.x"
        restore-keys: "${{ runner.os }}-gems-2.5-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-3-0-sinatra-2-0-x:
    name: ruby 3.0, sinatra-2.0.x
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.sinatra-2.0.x
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.0-sinatra-2.0.x"
        restore-keys: "${{ runner.os }}-gems-3.0-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-3-0-sinatra-edge:
    name: "[allowed to fail] ruby 3.0, sinatra-edge"
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.sinatra-edge
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.0-sinatra-edge"
        restore-keys: "${{ runner.os }}-gems-3.0-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-5-grape-rack_version-2-0-8:
    name: ruby 2.5, grape, RACK_VERSION=~> 2.0.8
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.grape
      RACK_VERSION: "~> 2.0.8"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.5'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.5-grape"
        restore-keys: "${{ runner.os }}-gems-2.5-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-grape:
    name: ruby 2.7, grape
    runs-on: ubuntu-latest
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.grape
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-grape"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-grape-grape_version-0-13-0-rack_version-2-0-8:
    name: ruby 2.7, grape, GRAPE_VERSION=~> 0.13.0 RACK_VERSION=~> 2.0.8
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.grape
      GRAPE_VERSION: "~> 0.13.0"
      RACK_VERSION: "~> 2.0.8"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-grape"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-grape-grape_version-1-1-0-rack_version-2-0-8:
    name: ruby 2.7, grape, GRAPE_VERSION=~> 1.1.0 RACK_VERSION=~> 2.0.8
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.grape
      GRAPE_VERSION: "~> 1.1.0"
      RACK_VERSION: "~> 2.0.8"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-grape"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-grape-grape_version-1-2-0-rack_version-2-0-8:
    name: ruby 2.7, grape, GRAPE_VERSION=~> 1.2.0 RACK_VERSION=~> 2.0.8
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.grape
      GRAPE_VERSION: "~> 1.2.0"
      RACK_VERSION: "~> 2.0.8"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-grape"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-grape-grape_version-1-3-0:
    name: ruby 2.7, grape, GRAPE_VERSION=~> 1.3.0
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.grape
      GRAPE_VERSION: "~> 1.3.0"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-grape"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-3-0-grape-grape_version-edge:
    name: "[allowed to fail] ruby 3.0, grape, GRAPE_VERSION=edge"
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.grape
      GRAPE_VERSION: edge
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.0-grape"
        restore-keys: "${{ runner.os }}-gems-3.0-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-rails-5-2-x-tilt_version-1-4-1:
    name: ruby 2.7, rails-5.2.x, TILT_VERSION=1.4.1
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
      TILT_VERSION: 1.4.1
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-3-0-sinatra-1-4-x-sequel_version-4-34-0:
    name: ruby 3.0, sinatra-1.4.x, SEQUEL_VERSION=4.34.0
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.sinatra-1.4.x
      SEQUEL_VERSION: 4.34.0
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.0-sinatra-1.4.x"
        restore-keys: "${{ runner.os }}-gems-3.0-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-rails-5-2-x-ams_version-0-8-3-sidekiq_version-none:
    name: ruby 2.7, rails-5.2.x, AMS_VERSION=~> 0.8.3 SIDEKIQ_VERSION=none
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
      AMS_VERSION: "~> 0.8.3"
      SIDEKIQ_VERSION: none
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-rails-5-2-x-ams_version-0-9-5:
    name: ruby 2.7, rails-5.2.x, AMS_VERSION=~> 0.9.5
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
      AMS_VERSION: "~> 0.9.5"
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-2-7-rails-5-2-x-ams_version-edge:
    name: "[allowed to fail] ruby 2.7, rails-5.2.x, AMS_VERSION=edge"
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-5.2.x
      AMS_VERSION: edge
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.7-rails-5.2.x"
        restore-keys: "${{ runner.os }}-gems-2.7-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-head-rails-6-1-x:
    name: "[allowed to fail] ruby head, rails-6.1.x"
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-6.1.x
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: head
    - name: Check ruby
      run: ruby -v | grep "3.1" -q
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.1-rails-6.1.x"
        restore-keys: "${{ runner.os }}-gems-3.1-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  ruby-head-rails-edge:
    name: "[allowed to fail] ruby head, rails-edge"
    runs-on: ubuntu-latest
    continue-on-error: true
    if: github.ref == 'refs/heads/master' || contains(github.event.pull_request.labels.*.name,
      'full-ci')
    env:
      BUNDLE_GEMFILE: gemfiles/Gemfile.rails-edge
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: head
    - name: Check ruby
      run: ruby -v | grep "3.1" -q
    - name: Install APT dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -yq sqlite libsqlite3-dev
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-3.1-rails-edge"
        restore-keys: "${{ runner.os }}-gems-3.1-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Run tests
      run: |
        bundle exec rake workflow:verify[$CONFIG_DIGEST]
        bundle exec rake
    - name: Run tests (agent disabled)
      env:
        COVERAGE_DIR: "${{ github.workspace }}/coverage-disabled"
        SKYLIGHT_DISABLE_AGENT: 'true'
      run: bundle exec rake
    - name: Prepare coverage files for upload
      run: |
        mkdir -p coverage-sync
        cp coverage/.resultset.json coverage-sync/coverage.$(uuidgen).json
        cp coverage-disabled/.resultset.json coverage-sync/coverage.disabled.$(uuidgen).json
    - name: Upload coverage files
      if: success()
      uses: actions/upload-artifact@v2
      with:
        name: coverage
        path: coverage-sync
    needs:
    - ruby-3-0-rails-6-1-x
  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Setup ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.5'
    - name: Setup cache
      uses: actions/cache@v2.1.4
      with:
        path: "${{ github.workspace }}/vendor/bundle"
        key: "${{ runner.os }}-gems-2.5-base"
        restore-keys: "${{ runner.os }}-gems-2.5-"
    - name: bundle install
      run: |
        gem install bundler
        bundle install
    - name: Set up Rubocop problem matcher
      run: echo "::add-matcher::${GITHUB_WORKSPACE}/.github/rubocop.json"
    - name: Run lint
      run: |
        bundle exec rubocop -v
        bundle exec rubocop
    if: always()
  upload-coverage:
    name: upload-coverage
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Set up commit metadata (push)
      if: github.event_name == 'push'
      env:
        GIT_COMMIT_SHA: "${{ github.sha }}"
        GIT_BRANCH: "${{ github.ref }}"
      run: |
        echo "GIT_COMMIT_SHA=${GIT_COMMIT_SHA}" >> $GITHUB_ENV
        echo "GIT_BRANCH=${GIT_BRANCH/refs/heads//}" >> $GITHUB_ENV
    - name: Set up commit metadata (pull_request)
      if: github.event_name == 'pull_request'
      env:
        GIT_COMMIT_SHA: "${{ github.event.pull_request.head.sha }}"
        GIT_BRANCH: "${{ github.event.pull_request.head.ref }}"
      run: |
        echo "GIT_COMMIT_SHA=${GIT_COMMIT_SHA}" >> $GITHUB_ENV
        echo "GIT_BRANCH=${GIT_BRANCH}" >> $GITHUB_ENV
    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
    - name: Install Codeclimate test reporter
      run: |
        curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
        chmod +x ./cc-test-reporter
    - name: Download coverage data
      uses: actions/download-artifact@v2
      with:
        name: coverage
        path: coverage
    - name: Prepare and upload coverage
      env:
        CC_TEST_REPORTER_ID: "${{ secrets.CC_TEST_REPORTER_ID }}"
      run: |
        mkdir -p formatted_coverage
        find coverage -name '*.json' | xargs -I % ./cc-test-reporter format-coverage -t simplecov -o formatted_coverage/% %
        ./cc-test-reporter sum-coverage formatted_coverage/**/*.json
        ./cc-test-reporter upload-coverage
    needs:
    - ruby-2-7-rails-5-2-x-mongo
    - ruby-2-7-rails-5-2-x-mongoid-6-mongoid_version-6-0
    - ruby-2-7-rails-5-2-x-elasticsearch
    - ruby-2-5-rails-5-2-x-sidekiq_version-4-graphql_version-1-7-0
    - ruby-2-7-rails-5-2-x-graphql_version-1-9-0
    - ruby-2-7-rails-5-2-x-graphql_version-1-8-0
    - ruby-3-0-rails-6-0-x
    - ruby-3-0-rails-6-1-x
    - ruby-2-5-sinatra-1-4-x
    - ruby-3-0-sinatra-1-4-x
    - ruby-2-5-sinatra-2-0-x
    - ruby-3-0-sinatra-2-0-x
    - ruby-2-5-grape-rack_version-2-0-8
    - ruby-2-7-grape
    - ruby-2-7-grape-grape_version-0-13-0-rack_version-2-0-8
    - ruby-2-7-grape-grape_version-1-1-0-rack_version-2-0-8
    - ruby-2-7-grape-grape_version-1-2-0-rack_version-2-0-8
    - ruby-2-7-grape-grape_version-1-3-0
    - ruby-2-7-rails-5-2-x-tilt_version-1-4-1
    - ruby-3-0-sinatra-1-4-x-sequel_version-4-34-0
    - ruby-2-7-rails-5-2-x-ams_version-0-8-3-sidekiq_version-none
    - ruby-2-7-rails-5-2-x-ams_version-0-9-5
    if: always()
  required-tests-passed:
    name: Required Tests Passed
    runs-on: ubuntu-latest
    steps:
    - name: Mark tests failed
      run: 'false'
      if: contains(needs.*.result, 'failure')
    - name: Mark tests passed
      run: 'true'
      if: "!contains(needs.*.result, 'failure')"
    needs:
    - ruby-2-7-rails-5-2-x-mongo
    - ruby-2-7-rails-5-2-x-mongoid-6-mongoid_version-6-0
    - ruby-2-7-rails-5-2-x-elasticsearch
    - ruby-2-5-rails-5-2-x-sidekiq_version-4-graphql_version-1-7-0
    - ruby-2-7-rails-5-2-x-graphql_version-1-9-0
    - ruby-2-7-rails-5-2-x-graphql_version-1-8-0
    - ruby-3-0-rails-6-0-x
    - ruby-3-0-rails-6-1-x
    - ruby-2-5-sinatra-1-4-x
    - ruby-3-0-sinatra-1-4-x
    - ruby-2-5-sinatra-2-0-x
    - ruby-3-0-sinatra-2-0-x
    - ruby-2-5-grape-rack_version-2-0-8
    - ruby-2-7-grape
    - ruby-2-7-grape-grape_version-0-13-0-rack_version-2-0-8
    - ruby-2-7-grape-grape_version-1-1-0-rack_version-2-0-8
    - ruby-2-7-grape-grape_version-1-2-0-rack_version-2-0-8
    - ruby-2-7-grape-grape_version-1-3-0
    - ruby-2-7-rails-5-2-x-tilt_version-1-4-1
    - ruby-3-0-sinatra-1-4-x-sequel_version-4-34-0
    - ruby-2-7-rails-5-2-x-ams_version-0-8-3-sidekiq_version-none
    - ruby-2-7-rails-5-2-x-ams_version-0-9-5
    if: always()
